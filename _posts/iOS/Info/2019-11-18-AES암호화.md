---
layout: post
title: AES암호화
categories: [iOS]
tags: [iOS 암호화]
description: iOS에서 AES암호화 하기
comments: false
---

- 암호화 알고리즘 자체에는 접근하지 않음
- iOS에서 키를 생성하고 암호화하는 2가지 방법 정리
- Objectivc-c 기준 CommonCrypto 사용

---



# 대칭키 생성

## 1.  c string 변환

### Sample
``` obj-c
NSString *key = @"!!!!!!";
int keySize = kCCKeySizeAES128;

char result[keySize+1];
bzero( result, sizeof(result) ); // 바이트 스트림 0으로 채움
    
[key getCString:result maxLength:sizeof(result) encoding:NSUTF8StringEncoding];
```
## 2. Secure 랜덤키 생성
```SecRandomCopyBytes(SecRandomRef rnd, size_t count, void *bytes)```
- 암호화 키 생성하는데 여러가지 (복잡한)방법이 있지만, 심플하게 생성하고 싶을 때 사용

### 매개변수

| 이름   | 설명                                  |
| ------ | ------------------------------------- |
| rnd    | kSecRandomDefault<br>랜덤한 숫자 생성 |
| count  | 1. 바이트 크기                        |
| *bytes | 바이트가 저장될 버퍼                  |

### Sample
``` obj-c
NSMutableData *sRandomData = [NSMutableData dataWithLength:16];
NSString *sRandomKey = nil;

int result = SecRandomCopyBytes(kSecRandomDefault, 16, sRandomData.mutableBytes);

sRandomKey = [sRandomData base64EncodedStringWithOptions:0];
```

## 3. CCKeyDerivationPBKDF 이용 키 생성
``` CCKeyDerivationPBKDF( CCPBKDFAlgorithm algorithm, const char *password, size_t passwordLen, const uint8_t *salt, size_t saltLen, CCPseudoRandomAlgorithm prf, unsigned rounds, uint8_t *derivedKey, size_t derivedKeyLen) ```

### 매개변수

| 이름          | 설명                                                         |
| ------------- | ------------------------------------------------------------ |
| algorithm     | kCCPBKDF2(해쉬 컨테이너 알고리즘) 만 제공                    |
| password      | 암호화할 데이터                                              |
| passwordLen   | 암호화할 데이터 크기                                         |
| salt          | 솔트 데이터                                                  |
| saltLen       | 솔트 데이터 크기<br> 32바이트 이상이어야 솔트와 다이제스트 추측하기 어려움 |
| prf           | 해시 알고리즘                                                |
| rounds        | 암호 반복 횟수                                               |
| *derivedKey   | 생성된 키 값이 저장될 버퍼                                   |
| derivedKeyLen | 생성될 키 데이터 크기                                        |

### 예제
``` obj-c
NSString *password  = @"abcdefghijklmnopqrst";
NSData *passwordData = [password dataUsingEncoding:NSUTF8StringEncoding];
    
uint8_t salt[] = {0x01, 0x06, 0x00, 0x07, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x07, 0x01, 0x04, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03};
        
 NSMutableData *result = [NSMutableData dataWithLength:16];
    
 int success = CCKeyDerivationPBKDF(kCCPBKDF2, passwordData.bytes, passwordData.length, salt, sizeof(salt), kCCPRFHmacAlgSHA1, 512, result.mutableBytes, 16);
```

# 암호화
``` const void *iv, const void *dataIn, size_t dataInLength, void *dataOut, size_t dataOutAvailable, size_t *dataOutMoved)```

### 매개변수

| 이름             | 설명                                                         |
| ---------------- | ------------------------------------------------------------ |
| op               | CCCrypt 수행할 동작<br>1. kCCEncrypt <br>2. kCCDecrypt       |
| alg              | 알고리즘                                                     |
| options          | block mode, padding 옵션<br> 모드 지정 안하면 default가 CBC모드 <br>1. kCCOptionPKCS7Padding<br>2.kCCOptionECBMode |
| key              | 대칭키                                                       |
| keyLength        | 대칭키 데이터 크기                                           |
| iv               | 초기화 벡터                                                  |
| dataIn           | 암호화 할 데이터                                             |
| dataInLength     | 암호화 할 데이터 크기                                        |
| dataOut          | 암호화된 데이터 버퍼                                         |
| dataOutAvailable | dataOut 버퍼 크기                                            |
| dataOutMoved     | 실제로 암호화 된 데이터 크기                                 |

## 참고 
좀 더 암호화 옵션 설정 상세하게 하고 싶을 때 Cryptor 만들어서 암호화 실행하면 됨.

1. CCCryptorCreateWithMode : 암호화 옵션 설정후 Cryptor 구조체?? 생성
2. CCCryptorGetOutputLength : 위의 Cryptor 로 암호화 buffer 크기 추출
3. CCCryptorUpdate : 중간 암호화
4. CCCryptorFinal : 마지막 암호화 (padding 등 문제로 암호화 2번 실행하는 듯)
5. CCCryptorRelease : Cryptor release


## 예제
``` obj-c
NSData *key; // 암호화 키
NSData *iv; // 초키화 벡터
NSData *data; // 암호화 할 데이터
NSMutableData *buffer = [NSMutableData dataWithLength:kCCKeySizeAES128]; //버퍼 생성

size_t outLength; //실제로 암호화 된 데이터 크기

CCCrypt(kCCEncrypt,
             kCCAlgorithmAES128,
             kCCOptionPKCS7Padding,
             key.bytes,
             key.length,
             iv,
             data.bytes,
             data.length,
             buffer.mutableBytes,
             buffer.length,
             &outLength);
             
NSData *encryptData = [[NSData alloc] initWithBytes:buffer.bytes length:outLength]
```

